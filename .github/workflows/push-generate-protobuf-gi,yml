name: Push - Create & Tag Protobuf - go

on:
  push:
    branches:
      - main

jobs:
  generate-protobuf-go:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      steps:
        - name: Checkout source
          uses: actions/checkout@v3
          with:
            ref: ${{ github.head_ref }}
        - name: Install go
          uses: actions/setup-go@v3
          with:
            go-version: '1.20'
            check-latest: false
            cache: true
        - name: Generate Go source
          shell: bash
          run: |
            make pipeline-build
        - name: Commit generated-files
          uses: stefanzweizel/git-auto-commit-action@v4
          with:
            commit_message: 'chore(protobuf-go): Auto-Generated by Github Action'
            tagging_message: ${{ steps.tag_version.outputs.new_tag }}
            file_patter: 'protogen/*'
        - name: Bump version and push tag
          id: tag_version
          uses: anothrNick/github-tag-action@1.61.0
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            WITH_V: true
            DEFAULT_BUMP: patch